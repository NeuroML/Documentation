
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimising/fitting NeuroML Models &#8212; NeuroML Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/zcustom.css?v=f191df08" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Userdocs/OptimisingNeuroMLModels';</script>
    <script src="../_static/search_boxes.js?v=5dfd38c8"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Testing/validating NeuroML Models" href="TestingNeuroMLModels.html" />
    <link rel="prev" title="Simulating NeuroML Models" href="SimulatingNeuroMLModels.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../Landing.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="NeuroML Documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="NeuroML Documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="MissionAndAims.html">Mission and Aims</a></li>
<li class="toctree-l1"><a class="reference internal" href="Usage.html">How to use this documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="GetNeuroML.html">Get NeuroML</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="GettingStarted.html">Getting started with NeuroML</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="SingleNeuronExample.html">Simulating a regular spiking Izhikevich neuron</a></li>
<li class="toctree-l2"><a class="reference internal" href="NML2_examples/SingleNeuron.html">Interactive single Izhikevich neuron NeuroML example</a></li>
<li class="toctree-l2"><a class="reference internal" href="IzhikevichNetworkExample.html">A two population network of regular spiking Izhikevich neurons</a></li>
<li class="toctree-l2"><a class="reference internal" href="NML2_examples/IzhikevichNetwork.html">Interactive two population network example</a></li>
<li class="toctree-l2"><a class="reference internal" href="SingleCompartmentHHExample.html">Simulating a single compartment Hodgkin-Huxley neuron</a></li>
<li class="toctree-l2"><a class="reference internal" href="NML2_examples/HH_single_compartment.html">Interactive single compartment HH example</a></li>
<li class="toctree-l2"><a class="reference internal" href="MultiCompartmentOLMexample.html">Simulating a multi compartment OLM neuron</a></li>
<li class="toctree-l2"><a class="reference internal" href="NML2_examples/OLM.html">Interactive multi-compartment OLM cell example</a></li>
<li class="toctree-l2"><a class="reference internal" href="NML2_examples/NeuroML-DB.html">Create novel NeuroML models from components on NeuroML-DB</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FindingNeuroMLModels.html">Finding and sharing NeuroML models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="CreatingNeuroMLModels.html">Creating NeuroML models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="ConvertingModels.html">Converting models to NeuroML and sharing them on Open Source Brain</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImportingMorphologyFiles.html">Handling Morphology Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="HDF5.html">HDF5 support</a></li>
<li class="toctree-l2"><a class="reference internal" href="Provenance.html">Maintaining provenance in NeuroML models</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="ValidatingNeuroMLModels.html">Validating NeuroML Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="VisualisingNeuroMLModels.html">Visualising NeuroML Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="VisualisingChannels.html">Visualising and analysing ion channel models</a></li>
<li class="toctree-l2"><a class="reference internal" href="VisualisingCells.html">Visualising and analysing cell models</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="SimulatingNeuroMLModels.html">Simulating NeuroML Models</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Optimising/fitting NeuroML Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="TestingNeuroMLModels.html">Testing/validating NeuroML Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="LEMS.html">LEMS: Low Entropy Model Specification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="LEMSOverview.html">Model structure overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample1.html">Example 1: Dimensions, Units, ComponentTypes and Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample2.html">Example 2: tidying up example 1</a></li>


<li class="toctree-l2"><a class="reference internal" href="LEMSExample3.html">Example 3: Connection dependent synaptic components</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample4.html">Example 4: Kinetic schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample5.html">Example 5: References and paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample6.html">Example 6: User defined types for simulation and display</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample7.html">Example 7: User defined types for networks and populations</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSExample8.html">Example 8: Regimes in Dynamics definitions</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Specification.html">Schema/Specification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="NeuroMLv2.html">NeuroML v2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="Schemas/NeuroMLDocument.html">NeuroMLDocument</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/NeuroMLCoreDimensions.html">NeuroMLCoreDimensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/NeuroMLCoreCompTypes.html">NeuroMLCoreCompTypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Cells.html">Cells</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Channels.html">Channels</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Synapses.html">Synapses</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Inputs.html">Inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Networks.html">Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/PyNN.html">PyNN</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Simulation.html">Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Schemas/Index.html">Index</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="NeuroMLv1.html">NeuroML v1</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="LEMSSchema.html">LEMS</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Modelstructure.html">Model structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Unitsanddimensions.html">Units and dimensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Definingcomponenttypes.html">Defining component types</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Dynamics.html">Dynamics</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Structure.html">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Simulation.html">Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Procedure.html">Procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/DefiningComponents.html">Defining Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="LEMS_elements/Geometry.html">Geometry</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="NeuroMLv2AndLEMS.html">NeuroML 2 and LEMS</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Conventions.html">Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="UnitsAndDimensions.html">Units and dimensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Paths.html">Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="QuantitiesAndRecording.html">Quantities and recording</a></li>
<li class="toctree-l2"><a class="reference internal" href="LEMSSimulation.html">LEMS Simulation files</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="ExtendingNeuroMLv2.html">Extending NeuroML</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Software/Software.html">Software and Tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Software/pyNeuroML.html">pyNeuroML</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/libNeuroML.html">libNeuroML</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/pyLEMS.html">pyLEMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/NeuroMLlite.html">NeuroMLlite</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/jNeuroML.html">jNeuroML</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/jLEMS.html">jLEMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/NeuroML_API.html">NeuroML C++ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Software/MatLab.html">MatLab NeuroML Toolbox</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="Software/SupportingTools.html">Tools and resources with NeuroML support</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/Approaches.html">Approaches to adding NeuroML support</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/NEURON.html">NEURON and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/NetPyNE.html">NetPyNE and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/PyNN.html">PyNN and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/Brian.html">Brian and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/MOOSE.html">MOOSE and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/EDEN.html">EDEN and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/Arbor.html">Arbor and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/N2A.html">N2A and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/NEST.html">NEST and NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Software/Tools/SWC.html">SWC and NeuroML</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Publications.html">Citing NeuroML and related publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Walkthroughs/Walkthroughs.html">Walk throughs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="Walkthroughs/RayEtAl2020/RayEtAl2020.html">Converting Ray et al 2020 to NeuroML</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="Walkthroughs/RayEtAl2020/Setup.html">Setting up</a></li>
<li class="toctree-l3"><a class="reference internal" href="Walkthroughs/RayEtAl2020/Conversion.html">Converting to NeuroML</a></li>
<li class="toctree-l3"><a class="reference internal" href="Walkthroughs/RayEtAl2020/OMV.html">Adding OMV tests</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NeuroML events</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Events/Events.html">NeuroML outreach and events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202407-CNS2024.html">July 2024: NeuroML tutorial at CNS 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202404-Harmony.html">April 2024: NeuroML hackathon at HARMONY 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/20220630-CNS2022.html">June 2022: NeuroML tutorial at CNS*2022 satellite tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202204-Harmony.html">April 2022: NeuroML development workshop at HARMONY 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202109-COMBINE.html">October 2021: NeuroML development workshop at COMBINE meeting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202108-INCF-Training-Week.html">August 2021: NeuroML tutorial at INCF Training Weeks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202107-CNS2021.html">July 2021: NeuroML tutorial at CNS*2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/202103-Harmony.html">March 2021: NeuroML hackathon at HARMONY 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/2012-Edinburgh.html">March 2012: Fourth NeuroML Development Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Events/PastEvents.html">Past NeuroML Events</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The NeuroML Initiative</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/CommunicationChannels.html">Getting in touch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/Standards.html">Overview of standards in neuroscience</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/History.html">A brief history of NeuroML</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../NeuroMLOrg/Board.html">NeuroML Editorial Board</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../NeuroMLOrg/BoardHistory.html">History of the NeuroML Editorial Board</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NeuroMLOrg/BoardMeetingReports.html">Workshop and Meeting reports</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/ScientificCommittee.html">NeuroML Scientific Committee</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/Funding.html">Funding and Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/OutreachTraining.html">Outreach and training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/Contributors.html">NeuroML contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/Repositories.html">NeuroML repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NeuroMLOrg/CoC.html">Code of Conduct</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Devdocs/Devdocs.html">Overview</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Devdocs/DevSOP.html">Contribution guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Devdocs/ReleaseProcess.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Devdocs/UpdatingStandard.html">Making changes to the NeuroML standard</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Devdocs/InteractionOtherBits.html">Interaction with other languages and standards</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Reference/Glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/zBibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/NeuroML/Documentation" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroML/Documentation/edit/main/source/Userdocs/OptimisingNeuroMLModels.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NeuroML/Documentation/issues/new?title=Issue%20on%20page%20%2FUserdocs/OptimisingNeuroMLModels.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Userdocs/OptimisingNeuroMLModels.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Optimising/fitting NeuroML Models</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data-and-calculating-metrics-to-use-for-optimisation">Loading data and calculating metrics to use for optimisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-optimisation">Running the optimisation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-a-template-model">Writing a template model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-optimisation-parameters">Setting up the optimisation parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calling-the-optimisation-function">Calling the optimisation function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-results">Viewing results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-results-and-running-a-fitted-model">Extracting results and running a fitted model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-model-generated-and-experimentally-recorded-membrane-potentials">Plotting model generated and experimentally recorded membrane potentials</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="optimising-fitting-neuroml-models">
<span id="userdocs-optimising"></span><h1>Optimising/fitting NeuroML Models<a class="headerlink" href="#optimising-fitting-neuroml-models" title="Link to this heading">#</a></h1>
<p><a class="reference internal" href="Software/pyNeuroML.html#pyneuroml"><span class="std std-ref">pyNeuroML</span></a> includes the <a class="reference external" href="https://pyneuroml.readthedocs.io/en/development/pyneuroml.tune.html#module-pyneuroml.tune.NeuroMLTuner">NeuroMLTuner</a> module for the tuning and optimisation of NeuroML models against provided data.
This uses the <a class="reference external" href="https://github.com/NeuralEnsemble/neurotune/">Neurotune</a> Python package for the fitting of models using evolutionary computation.</p>
<p>This page will walk through an example model optimisation.</p>
<div class="container-fluid">
<div class="row my-2 py-2">
<div class="col-sm-6 px-2">
<center>
<figure class="align-default" id="id3">
<img alt="Membrane potential from example experimental data." src="../_images/fitted_izhikevich_sim-exp-v.png" />
<figcaption>
<p><span class="caption-number">Fig. 45 </span><span class="caption-text">Membrane potential from the experimental data.</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
</center>
</div>
<div class="col-sm-6 px-2">
<center>
<figure class="align-default" id="id4">
<img alt="Membrane potential obtained from example fitted model." src="../_images/fitted_izhikevich_output.png" />
<figcaption>
<p><span class="caption-number">Fig. 46 </span><span class="caption-text">Membrane potential obtained from the model with highest fitness.</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
</center>
</div>
</div>
</div>
<p>The Python script used to run the optimisation and generate the graphs is given below.
This can be adapted for other optimisations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example file showing the tuning of an Izhikevich neuron using pyNeuroML.</span>

<span class="sd">File: source/Userdocs/NML2_examples/tune-izhikevich.py</span>

<span class="sd">Copyright 2023 NeuroML contributors</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">pyneuroml.tune.NeuroMLTuner</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_optimisation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynwb</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyelectro.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_network_analysis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyneuroml.pynml</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_neuroml2_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyneuroml.pynml</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyneuroml.pynml</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_lems_with_jneuroml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroml</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">NeuroMLDocument</span><span class="p">,</span>
    <span class="n">Izhikevich2007Cell</span><span class="p">,</span>
    <span class="n">PulseGenerator</span><span class="p">,</span>
    <span class="n">Network</span><span class="p">,</span>
    <span class="n">Population</span><span class="p">,</span>
    <span class="n">ExplicitInput</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hdmf.container</span><span class="w"> </span><span class="kn">import</span> <span class="n">Container</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyneuroml.lems.LEMSSimulation</span><span class="w"> </span><span class="kn">import</span> <span class="n">LEMSSimulation</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_data_metrics</span><span class="p">(</span><span class="n">datafile</span><span class="p">:</span> <span class="n">Container</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyse the data to get metrics to tune against.</span>

<span class="sd">    :returns: metrics from pyelectro analysis, currents, and the membrane potential values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analysis_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">currents</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">memb_vals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_acquisitions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_acquisitions</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Going over acquisition # </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">))</span>

        <span class="c1"># stimulus lasts about 1000ms, so we take about the first 1500 ms</span>
        <span class="n">data_v</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">15000</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="p">)</span>
        <span class="c1"># get sampling rate from the data</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span>
            <span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rate</span>
        <span class="c1"># generate time steps from sampling rate</span>
        <span class="n">data_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_v</span><span class="p">)</span> <span class="o">/</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="c1"># run the analysis</span>
        <span class="n">analysis_results</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_network_analysis</span><span class="p">({</span><span class="n">acq</span><span class="p">:</span> <span class="n">data_v</span><span class="p">},</span> <span class="n">data_t</span><span class="p">)</span>

        <span class="c1"># extract current from description, but can be extracted from other</span>
        <span class="c1"># locations also, such as the CurrentClampStimulus series.</span>
        <span class="n">data_i</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_i</span>
        <span class="n">memb_vals</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_t</span><span class="p">,</span> <span class="n">data_v</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">,</span> <span class="n">memb_vals</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">tune_izh_model</span><span class="p">(</span><span class="n">acq_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">metrics_from_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">currents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tune networks model against the data.</span>

<span class="sd">    Here we generate a network with the necessary number of Izhikevich cells,</span>
<span class="sd">    one for each current stimulus, and tune them against the experimental data.</span>

<span class="sd">    :param acq_list: list of indices of acquisitions/sweeps to tune against</span>
<span class="sd">    :type acq_list: list</span>
<span class="sd">    :param metrics_from_data: dictionary with the sweep number as index, and</span>
<span class="sd">        the dictionary containing metrics generated from the analysis</span>
<span class="sd">    :type metrics_from_data: dict</span>
<span class="sd">    :param currents: dictionary with sweep number as index and stimulus current</span>
<span class="sd">        value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># length of simulation of the cells---should match the length of the</span>
    <span class="c1"># experiment</span>
    <span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1500.0</span>
    <span class="c1"># Create a NeuroML template network simulation file that we will use for</span>
    <span class="c1"># the tuning</span>
    <span class="n">template_doc</span> <span class="o">=</span> <span class="n">NeuroMLDocument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;IzhTuneNet&quot;</span><span class="p">)</span>
    <span class="c1"># Add an Izhikevich cell with some parameters to the document</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">izhikevich2007_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Izhikevich2007Cell</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="s2">&quot;100pF&quot;</span><span class="p">,</span>
            <span class="n">v0</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="s2">&quot;0.7nS_per_mV&quot;</span><span class="p">,</span>
            <span class="n">vr</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">vt</span><span class="o">=</span><span class="s2">&quot;-40mV&quot;</span><span class="p">,</span>
            <span class="n">vpeak</span><span class="o">=</span><span class="s2">&quot;35mV&quot;</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="s2">&quot;0.03per_ms&quot;</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="s2">&quot;-2nS&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;-50.0mV&quot;</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="s2">&quot;100pA&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">))</span>
    <span class="c1"># Add a cell for each acquisition list</span>
    <span class="n">popsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pop0&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">popsize</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a current source for each cell, matching the currents that</span>
    <span class="c1"># were used in the experimental study.</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">pulse_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PulseGenerator</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span>
                <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;80ms&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;1000ms&quot;</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explicit_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ExplicitInput</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Print a summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">template_doc</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Write to a neuroml file and validate it.</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;TuneIzhFergusonPyr3&quot;</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.net.nml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">write_neuroml2_file</span><span class="p">(</span><span class="n">template_doc</span><span class="p">,</span> <span class="n">template_filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Now for the tuning bits</span>

    <span class="c1"># format is type:id/variable:id/units</span>
    <span class="c1"># supported types: cell/channel/izhikevich2007cell</span>
    <span class="c1"># supported variables:</span>
    <span class="c1">#  - channel: vShift</span>
    <span class="c1">#  - cell: channelDensity, vShift_channelDensity, channelDensityNernst,</span>
    <span class="c1">#  erev_id, erev_ion, specificCapacitance, resistivity</span>
    <span class="c1">#  - izhikevich2007Cell: all available attributes</span>

    <span class="c1"># we want to tune these parameters within these ranges</span>
    <span class="c1"># param: (min, max)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/C/pF&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/k/nS_per_mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vr/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vt/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vpeak/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/a/per_ms&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/b/nS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/c/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/d/pA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[str, Tuple[float, float]]</span>

    <span class="c1"># Set up our target data and so on</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="c1"># data to fit to:</span>
        <span class="c1"># format: path/to/variable:metric</span>
        <span class="c1"># metric from pyelectro, for example:</span>
        <span class="c1"># https://pyelectro.readthedocs.io/en/latest/pyelectro.html?highlight=mean_spike_frequency#pyelectro.analysis.mean_spike_frequency</span>
        <span class="n">mean_spike_frequency</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">average_last_1percent</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">first_spike_time</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>

        <span class="c1"># each metric can have an associated weight</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># value of the target data from our data set</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># only add these if the experimental data includes them</span>
        <span class="c1"># these are only generated for traces with spikes</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_maximum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_minimum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># simulator to use</span>
    <span class="n">simulator</span> <span class="o">=</span> <span class="s2">&quot;jNeuroML&quot;</span>

    <span class="k">return</span> <span class="n">run_optimisation</span><span class="p">(</span>
        <span class="c1"># Prefix for new files</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;TuneIzh&quot;</span><span class="p">,</span>
        <span class="c1"># Name of the NeuroML template file</span>
        <span class="n">neuroml_file</span><span class="o">=</span><span class="n">template_filename</span><span class="p">,</span>
        <span class="c1"># Name of the network</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">,</span>
        <span class="c1"># Parameters to be fitted</span>
        <span class="n">parameters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="c1"># Our max and min constraints</span>
        <span class="n">min_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="n">max_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="c1"># Weights we set for parameters</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="c1"># The experimental metrics to fit to</span>
        <span class="n">target_data</span><span class="o">=</span><span class="n">target_data</span><span class="p">,</span>
        <span class="c1"># Simulation time</span>
        <span class="n">sim_time</span><span class="o">=</span><span class="n">sim_time</span><span class="p">,</span>
        <span class="c1"># EC parameters</span>
        <span class="n">population_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">max_evaluations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">num_selected</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">num_offspring</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">num_elites</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="c1"># Seed value</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span>
        <span class="c1"># Simulator</span>
        <span class="n">simulator</span><span class="o">=</span><span class="n">simulator</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="s1">&#39;-nogui&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span>
        <span class="n">save_to_file</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_fitness.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_scatter</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_scatter.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_hist</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_hist.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_output</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_output.png&quot;</span><span class="p">,</span>
        <span class="n">num_parallel_evaluations</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_fitted_cell_simulation</span><span class="p">(</span>
    <span class="n">sweeps_to_tune_against</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">tuning_report</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a simulation with the values obtained from the fitting</span>

<span class="sd">    :param tuning_report: tuning report from the optimser</span>
<span class="sd">    :type tuning_report: Dict</span>
<span class="sd">    :param simulation_id: text id of simulation</span>
<span class="sd">    :type simulation_id: str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the fittest variables</span>
    <span class="n">fittest_vars</span> <span class="o">=</span> <span class="n">tuning_report</span><span class="p">[</span><span class="s2">&quot;fittest vars&quot;</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/C/pF&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;pF&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/k/nS_per_mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;nS_per_mV&quot;</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vr/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">vt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vt/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">vpeak</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vpeak/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/a/per_ms&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;per_ms&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/b/nS&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;nS&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/c/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/d/pA&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;pA&quot;</span>

    <span class="c1"># Create a simulation using our obtained parameters.</span>
    <span class="c1"># Note that the tuner generates a graph with the fitted values already, but</span>
    <span class="c1"># we want to keep a copy of our fitted cell also, so we&#39;ll create a NeuroML</span>
    <span class="c1"># Document ourselves also.</span>
    <span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1500.0</span>
    <span class="n">simulation_doc</span> <span class="o">=</span> <span class="n">NeuroMLDocument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;FittedNet&quot;</span><span class="p">)</span>
    <span class="c1"># Add an Izhikevich cell with some parameters to the document</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">izhikevich2007_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Izhikevich2007Cell</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
            <span class="n">v0</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">vr</span><span class="o">=</span><span class="n">vr</span><span class="p">,</span>
            <span class="n">vt</span><span class="o">=</span><span class="n">vt</span><span class="p">,</span>
            <span class="n">vpeak</span><span class="o">=</span><span class="n">vpeak</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">))</span>
    <span class="c1"># Add a cell for each acquisition list</span>
    <span class="n">popsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">)</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pop0&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">popsize</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a current source for each cell, matching the currents that</span>
    <span class="c1"># were used in the experimental study.</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">simulation_doc</span><span class="o">.</span><span class="n">pulse_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PulseGenerator</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span>
                <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;80ms&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;1000ms&quot;</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explicit_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ExplicitInput</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Print a summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simulation_doc</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Write to a neuroml file and validate it.</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;FittedIzhFergusonPyr3&quot;</span>
    <span class="n">simulation_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.net.nml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">write_neuroml2_file</span><span class="p">(</span><span class="n">simulation_doc</span><span class="p">,</span> <span class="n">simulation_filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">simulation</span> <span class="o">=</span> <span class="n">LEMSSimulation</span><span class="p">(</span>
        <span class="n">sim_id</span><span class="o">=</span><span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">sim_time</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">,</span>
        <span class="n">simulation_seed</span><span class="o">=</span><span class="mi">54321</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">include_neuroml2_file</span><span class="p">(</span><span class="n">simulation_filename</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">create_output_file</span><span class="p">(</span><span class="s2">&quot;output0&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.v.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simulation_id</span><span class="p">))</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">add_column_to_output_file</span><span class="p">(</span>
            <span class="s2">&quot;output0&quot;</span><span class="p">,</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">simulation_file</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">()</span>
    <span class="c1"># simulate</span>
    <span class="n">run_lems_with_jneuroml</span><span class="p">(</span><span class="n">simulation_file</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="s2">&quot;2G&quot;</span><span class="p">,</span> <span class="n">nogui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_sim_data</span><span class="p">(</span>
    <span class="n">sweeps_to_tune_against</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memb_pots</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot data from our fitted simulation</span>

<span class="sd">    :param simulation_id: string id of simulation</span>
<span class="sd">    :type simulation_id: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plot</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.v.dat&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">)</span>

    <span class="c1"># construct data for plotting</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_vals_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sim_v_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_v_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_t_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stim_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">stim_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]))</span>

        <span class="c1"># remains the same for all columns</span>
        <span class="n">time_vals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">sim_v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_array</span><span class="p">[:,</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="n">data_v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memb_pots</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data_t_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memb_pots</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Model membrane potential plot</span>
    <span class="n">generate_plot</span><span class="p">(</span>
        <span class="n">xvalues</span><span class="o">=</span><span class="n">time_vals_list</span><span class="p">,</span>
        <span class="n">yvalues</span><span class="o">=</span><span class="n">sim_v_list</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">stim_vals</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Membrane potential (model)&quot;</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_figure_to</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-model-v.png&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;time (ms)&quot;</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;membrane potential (mV)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># data membrane potential plot</span>
    <span class="n">generate_plot</span><span class="p">(</span>
        <span class="n">xvalues</span><span class="o">=</span><span class="n">data_t_list</span><span class="p">,</span>
        <span class="n">yvalues</span><span class="o">=</span><span class="n">data_v_list</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">stim_vals</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Membrane potential (exp)&quot;</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_figure_to</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-exp-v.png&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;time (ms)&quot;</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;membrane potential (mV)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># set the default size for generated plots</span>
    <span class="c1"># https://matplotlib.org/stable/tutorials/introductory/customizing.html#a-sample-matplotlibrc-file</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>

    <span class="n">io</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span><span class="s2">&quot;./FergusonEtAl2015_PYR3.nwb&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">datafile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">,</span> <span class="n">memb_pots</span> <span class="o">=</span> <span class="n">get_data_metrics</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

    <span class="c1"># Choose what sweeps to tune against.</span>
    <span class="c1"># There are 33 sweeps: 1..33.</span>
    <span class="c1"># sweeps_to_tune_against = [1, 2, 15, 30, 31, 32, 33]</span>
    <span class="n">sweeps_to_tune_against</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">tune_izh_model</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">,</span> <span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">)</span>

    <span class="n">simulation_id</span> <span class="o">=</span> <span class="s2">&quot;fitted_izhikevich_sim&quot;</span>
    <span class="n">run_fitted_cell_simulation</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">)</span>

    <span class="n">plot_sim_data</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">,</span> <span class="n">memb_pots</span><span class="p">)</span>

    <span class="c1"># close the data file</span>
    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<section id="loading-data-and-calculating-metrics-to-use-for-optimisation">
<span id="userdocs-optimising-data"></span><h2>Loading data and calculating metrics to use for optimisation<a class="headerlink" href="#loading-data-and-calculating-metrics-to-use-for-optimisation" title="Link to this heading">#</a></h2>
<p>The first step in the optimisation of the model is to obtain the data that the model is to be fitted against.
In this example, we will use the data set of CA1 pyramidal cell recordings using an intact whole hippocampus preparation, including recordings of rebound firing <span id="id1">[<a class="reference internal" href="../Reference/zBibliography.html#id17" title="KA Ferguson, CYL Huh, B Amilhon, S Williams, and FK Skinner. Data set of CA1 pyramidal cell recordings using an intact whole hippocampus preparation, including recordings of rebound firing (V2). May 2015. URL: https://doi.org/10.5281/zenodo.17794, doi:10.5281/zenodo.17794.">FHA+15</a>]</span>.
The data set is provided in the <a class="reference external" href="https://nwb.org">Neurodata Without Borders</a> (NWB) format.
It can can be downloaded <a class="reference external" href="https://github.com/OpenSourceBrain/NWBShowcase/tree/master/FergusonEtAl2015">here on the Open Source Brain repository</a>, and can also be viewed on the <a class="reference external" href="https://nwbexplorer.opensourcebrain.org">NWB Explorer</a> web application:</p>
<figure class="align-default" id="id5">
<img alt="Screenshot showing two recordings from FergusonEtAl2015_PYR3.nwb in NWB Explorer." src="../_images/fitted_izhikevich_screenshot_nwbexplorer.png" />
<figcaption>
<p><span class="caption-number">Fig. 47 </span><span class="caption-text">Screenshot showing two recordings from FergusonEtAl2015_PYR3.nwb in NWB Explorer.</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>For this example, we will use the <a class="reference external" href="https://github.com/OpenSourceBrain/NWBShowcase/blob/master/FergusonEtAl2015/FergusonEtAl2015_PYR3.nwb">FergusonEtAl2015_PYR3.nwb</a> data file.
We use the <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/">PyNWB</a> package to read it, and then pass the loaded data to our <code class="docutils literal notranslate"><span class="pre">get_data_metrics</span></code> function to extract the metrics we want to use for model fitting.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">io</span> <span class="o">=</span> <span class="n">pynwb</span><span class="o">.</span><span class="n">NWBHDF5IO</span><span class="p">(</span><span class="s2">&quot;./FergusonEtAl2015_PYR3.nwb&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">datafile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">,</span> <span class="n">memb_pots</span> <span class="o">=</span> <span class="n">get_data_metrics</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
</pre></div>
</div>
<p>Similar to <a class="reference internal" href="Software/libNeuroML.html#libneuroml"><span class="std std-ref">libNeuroML</span></a>, PyNWB provides a Python object model to interact with NWB files.
You can learn more on using PyNWB in its <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/">documentation</a>.</p>
<p>Here, the data file includes recordings from multiple (33 in total) current clamp experiments that are numbered from 1 through 33.
We iterate over each recording individually to extract the membrane potential values and store them in <code class="docutils literal notranslate"><span class="pre">data_v</span></code>.
For each, we also calculate the time stamps for the recordings from the provided sampling rate.
We pass this information to the <code class="docutils literal notranslate"><span class="pre">simple_network_analysis</span></code> function provided by the <a class="reference external" href="https://github.com/NeuralEnsemble/pyelectro">PyElectro</a> Python package to calculate features (metrics) that we will use for fitting a neuron model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_data_metrics</span><span class="p">(</span><span class="n">datafile</span><span class="p">:</span> <span class="n">Container</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyse the data to get metrics to tune against.</span>

<span class="sd">    :returns: metrics from pyelectro analysis, currents, and the membrane potential values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analysis_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">currents</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">memb_vals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_acquisitions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_acquisitions</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Going over acquisition # </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">))</span>

        <span class="c1"># stimulus lasts about 1000ms, so we take about the first 1500 ms</span>
        <span class="n">data_v</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">15000</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="p">)</span>
        <span class="c1"># get sampling rate from the data</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span>
            <span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rate</span>
        <span class="c1"># generate time steps from sampling rate</span>
        <span class="n">data_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_v</span><span class="p">)</span> <span class="o">/</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="c1"># run the analysis</span>
        <span class="n">analysis_results</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_network_analysis</span><span class="p">({</span><span class="n">acq</span><span class="p">:</span> <span class="n">data_v</span><span class="p">},</span> <span class="n">data_t</span><span class="p">)</span>

        <span class="c1"># extract current from description, but can be extracted from other</span>
        <span class="c1"># locations also, such as the CurrentClampStimulus series.</span>
        <span class="n">data_i</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datafile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s2">&quot;CurrentClampSeries_</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_i</span>
        <span class="n">memb_vals</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_t</span><span class="p">,</span> <span class="n">data_v</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">,</span> <span class="n">memb_vals</span><span class="p">)</span>
</pre></div>
</div>
<p>The features calculated by PyElectro for each recording, which we store in <code class="docutils literal notranslate"><span class="pre">analysis_results</span></code>, can be seen below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Going over acquisition # 1</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;1:average_last_1percent&#39;: -60.4182980855306,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;1:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;1:maximum&#39;: -57.922367,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;1:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;1:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;1:minimum&#39;: -60.729984}</span>
<span class="go">Going over acquisition # 2</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;2:average_last_1percent&#39;: -60.2773068745931,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;2:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;2:maximum&#39;: -56.182865,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;2:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;2:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;2:minimum&#39;: -60.882572}</span>
<span class="go">Going over acquisition # 3</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;3:average_last_1percent&#39;: -60.175174713134766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;3:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;3:maximum&#39;: -54.22974,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;3:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;3:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;3:minimum&#39;: -60.7605}</span>
<span class="go">Going over acquisition # 4</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;4:average_last_1percent&#39;: -60.11576716105143,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;4:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;4:maximum&#39;: -49.133305,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;4:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;4:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;4:minimum&#39;: -60.607914}</span>
<span class="go">Going over acquisition # 5</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;5:average_last_1percent&#39;: -59.628299713134766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;5:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;5:maximum&#39;: -48.645023,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;5:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;5:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;5:minimum&#39;: -60.241703}</span>
<span class="go">Going over acquisition # 6</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;6:average_last_1percent&#39;: -60.04679743448893,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;6:max_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;6:maximum&#39;: -45.16602,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;6:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;6:min_peak_no&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;6:minimum&#39;: -60.699467}</span>
<span class="go">Going over acquisition # 7</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;7:average_last_1percent&#39;: -59.88566462198893,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:average_maximum&#39;: 66.3147,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:average_minimum&#39;: -47.9126,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:first_spike_time&#39;: 482.20000000000005,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:max_peak_no&#39;: 2,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:maximum&#39;: 67.38281,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:min_peak_no&#39;: 1,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;7:minimum&#39;: -60.15015}</span>
<span class="go">Going over acquisition # 8</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;8:average_last_1percent&#39;: -60.5531857808431,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:average_maximum&#39;: 64.63623,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:average_minimum&#39;: -46.05103,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:first_spike_time&#39;: 280.8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:max_peak_no&#39;: 2,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:maximum&#39;: 65.460205,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:mean_spike_frequency&#39;: 0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:min_peak_no&#39;: 1,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;8:minimum&#39;: -61.096195}</span>
<span class="go">Going over acquisition # 9</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;9:average_last_1percent&#39;: -60.2797482808431,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:average_maximum&#39;: 62.187195,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:average_minimum&#39;: -45.867924,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:first_spike_time&#39;: 192.10000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:interspike_time_covar&#39;: 0.12604539832023948,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:max_interspike_time&#39;: 233.69999999999993,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:max_peak_no&#39;: 4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:maximum&#39;: 64.42261,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:mean_spike_frequency&#39;: 4.984216647283602,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:min_interspike_time&#39;: 172.29999999999995,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:min_peak_no&#39;: 3,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:minimum&#39;: -60.91309,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:peak_decay_exponent&#39;: -0.008125577959852965,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:peak_linear_gradient&#39;: -0.007648055557429393,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:spike_broadening&#39;: 0.891046031985908,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:spike_frequency_adaptation&#39;: -0.05850411039850073,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:spike_width_adaptation&#39;: 0.02767948174212246,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:trough_decay_exponent&#39;: -0.00318728965696189,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;9:trough_phase_adaptation&#39;: -0.05016262394149966}</span>
<span class="go">Going over acquisition # 10</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;10:average_last_1percent&#39;: -60.4292844136556,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:average_maximum&#39;: 59.680183,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:average_minimum&#39;: -44.731144,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:first_spike_time&#39;: 156.9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:interspike_time_covar&#39;: 0.5779639183148945,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:max_interspike_time&#39;: 438.5000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:max_peak_no&#39;: 5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:maximum&#39;: 62.072758,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:mean_spike_frequency&#39;: 4.553215708594194,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:min_interspike_time&#39;: 132.60000000000005,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:min_peak_no&#39;: 4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:minimum&#39;: -60.882572,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:peak_decay_exponent&#39;: -0.009585017031582235,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:peak_linear_gradient&#39;: -0.005260966229876463,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:spike_broadening&#39;: 0.8756680523402136,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:spike_frequency_adaptation&#39;: -0.04780471479504103,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:spike_width_adaptation&#39;: 0.014551159295128686,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:trough_decay_exponent&#39;: -0.006056437839814275,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;10:trough_phase_adaptation&#39;: -0.04269124477477909}</span>
<span class="go">Going over acquisition # 11</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;11:average_last_1percent&#39;: -60.84635798136393,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:average_maximum&#39;: 58.73414,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:average_minimum&#39;: -43.800358,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:first_spike_time&#39;: 138.1,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:interspike_time_covar&#39;: 0.18317620745649893,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:max_interspike_time&#39;: 179.9999999999999,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:max_peak_no&#39;: 5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:maximum&#39;: 61.03516,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:mean_spike_frequency&#39;: 7.033585370142431,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:min_interspike_time&#39;: 106.50000000000003,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:min_peak_no&#39;: 4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:minimum&#39;: -61.248783,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:peak_decay_exponent&#39;: -0.010372120562797708,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:peak_linear_gradient&#39;: -0.0074866848970347325,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:spike_broadening&#39;: 0.8498887121142943,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:spike_frequency_adaptation&#39;: -0.052381521145715274,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:spike_width_adaptation&#39;: 0.025414793671653328,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:trough_decay_exponent&#39;: -0.007552906636393599,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;11:trough_phase_adaptation&#39;: -0.04473631982885844}</span>
<span class="go">Going over acquisition # 12</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;12:average_last_1percent&#39;: -61.085208892822266,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:average_maximum&#39;: 58.481857,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:average_minimum&#39;: -42.974857,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:first_spike_time&#39;: 127.40000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:interspike_time_covar&#39;: 0.16275057704467177,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:max_interspike_time&#39;: 136.5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:max_peak_no&#39;: 6,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:maximum&#39;: 61.737064,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:mean_spike_frequency&#39;: 8.791981712678037,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:min_interspike_time&#39;: 84.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:min_peak_no&#39;: 5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:minimum&#39;: -61.462406,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:peak_decay_exponent&#39;: -0.015987075984851808,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:peak_linear_gradient&#39;: -0.009383652380440125,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:spike_broadening&#39;: 0.8205694396572242,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:spike_frequency_adaptation&#39;: -0.04259621402895674,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:spike_width_adaptation&#39;: 0.0228428573204052,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:trough_decay_exponent&#39;: -0.012180031782655684,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;12:trough_phase_adaptation&#39;: 0.0003391093549627843}</span>
<span class="go">Going over acquisition # 13</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;13:average_last_1percent&#39;: -60.6233762105306,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:average_maximum&#39;: 56.980137,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:average_minimum&#39;: -42.205814,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:first_spike_time&#39;: 122.9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:interspike_time_covar&#39;: 0.1989630987796946,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:max_interspike_time&#39;: 138.9000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:max_peak_no&#39;: 8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:maximum&#39;: 61.30982,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:mean_spike_frequency&#39;: 9.743875278396434,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:min_interspike_time&#39;: 75.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:min_peak_no&#39;: 7,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:minimum&#39;: -60.974125,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:peak_decay_exponent&#39;: -0.01856642711769415,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:peak_linear_gradient&#39;: -0.009561076077386068,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:spike_broadening&#39;: 0.803052014150605,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:spike_frequency_adaptation&#39;: -0.028079821139188187,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:spike_width_adaptation&#39;: 0.01504310702538977,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:trough_decay_exponent&#39;: -0.013208504624154408,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;13:trough_phase_adaptation&#39;: -0.025379665674913895}</span>
<span class="go">Going over acquisition # 14</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;14:average_last_1percent&#39;: -60.723270416259766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:average_maximum&#39;: 55.986195,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:average_minimum&#39;: -41.54587,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:first_spike_time&#39;: 114.8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:interspike_time_covar&#39;: 0.34335772265161896,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:max_interspike_time&#39;: 194.39999999999998,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:max_peak_no&#39;: 9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:maximum&#39;: 60.882572,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:mean_spike_frequency&#39;: 8.785416209092906,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:min_interspike_time&#39;: 74.40000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:min_peak_no&#39;: 8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:minimum&#39;: -61.126713,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:peak_decay_exponent&#39;: -0.022541304298167242,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:peak_linear_gradient&#39;: -0.008000988888256885,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:spike_broadening&#39;: 0.8009562042583951,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:spike_frequency_adaptation&#39;: -0.022434594832088855,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:spike_width_adaptation&#39;: 0.010424354074822617,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:trough_decay_exponent&#39;: -0.018754566142487872,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;14:trough_phase_adaptation&#39;: -0.019014319738344054}</span>
<span class="go">Going over acquisition # 15</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;15:average_last_1percent&#39;: -60.99833552042643,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:average_maximum&#39;: 55.89295,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:average_minimum&#39;: -40.78892,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:first_spike_time&#39;: 113.2,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:interspike_time_covar&#39;: 0.6436697297327385,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:max_interspike_time&#39;: 311.30000000000007,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:max_peak_no&#39;: 8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:maximum&#39;: 60.91309,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:mean_spike_frequency&#39;: 8.201523140011716,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:min_interspike_time&#39;: 71.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:min_peak_no&#39;: 7,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:minimum&#39;: -61.370853,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:peak_decay_exponent&#39;: -0.025953113905923406,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:peak_linear_gradient&#39;: -0.008306657481016694,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:spike_broadening&#39;: 0.7782197474305453,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:spike_frequency_adaptation&#39;: -0.030010388928284993,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:spike_width_adaptation&#39;: 0.012108100430332605,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:trough_decay_exponent&#39;: -0.01262141611091244,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;15:trough_phase_adaptation&#39;: -0.025746376793896804}</span>
<span class="go">Going over acquisition # 16</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;16:average_last_1percent&#39;: -60.380863189697266,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:average_maximum&#39;: 54.52382,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:average_minimum&#39;: -39.78882,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:first_spike_time&#39;: 108.9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:interspike_time_covar&#39;: 0.23652534644271225,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:max_interspike_time&#39;: 123.00000000000011,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:max_peak_no&#39;: 11,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:maximum&#39;: 60.7605,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:mean_spike_frequency&#39;: 10.8837614279495,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:min_interspike_time&#39;: 59.30000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:min_peak_no&#39;: 10,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:minimum&#39;: -60.79102,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:peak_decay_exponent&#39;: -0.03301104578192642,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:peak_linear_gradient&#39;: -0.007545664792227554,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:spike_broadening&#39;: 0.7546314677569799,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:spike_frequency_adaptation&#39;: -0.013692136410690963,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:spike_width_adaptation&#39;: 0.008664177864358623,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:trough_decay_exponent&#39;: -0.023836469122601508,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;16:trough_phase_adaptation&#39;: -0.010081239597430595}</span>
<span class="go">Going over acquisition # 17</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;17:average_last_1percent&#39;: -60.552982330322266,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:average_maximum&#39;: 54.44642,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:average_minimum&#39;: -39.008247,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:first_spike_time&#39;: 105.6,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:interspike_time_covar&#39;: 0.19651182311074483,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:max_interspike_time&#39;: 106.29999999999995,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:max_peak_no&#39;: 10,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:maximum&#39;: 60.63843,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:mean_spike_frequency&#39;: 11.506008693428791,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:min_interspike_time&#39;: 58.60000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:min_peak_no&#39;: 9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:minimum&#39;: -61.03516,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:peak_decay_exponent&#39;: -0.03684157763477531,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:peak_linear_gradient&#39;: -0.009090863209461205,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:spike_broadening&#39;: 0.7534694949245309,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:spike_frequency_adaptation&#39;: -0.023373852901912264,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:spike_width_adaptation&#39;: 0.011268432654001511,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:trough_decay_exponent&#39;: -0.020590018720385343,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;17:trough_phase_adaptation&#39;: -0.00906121257722172}</span>
<span class="go">Going over acquisition # 18</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;18:average_last_1percent&#39;: -60.64799372355143,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:average_maximum&#39;: 53.783077,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:average_minimum&#39;: -38.424683,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:first_spike_time&#39;: 104.2,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:interspike_time_covar&#39;: 0.2502832189694502,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:max_interspike_time&#39;: 124.59999999999991,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:max_peak_no&#39;: 11,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:maximum&#39;: 60.63843,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:mean_spike_frequency&#39;: 11.420740063956146,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:min_interspike_time&#39;: 53.09999999999998,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:min_peak_no&#39;: 10,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:minimum&#39;: -61.03516,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:peak_decay_exponent&#39;: -0.04141134556729957,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:peak_linear_gradient&#39;: -0.008476351143979814,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:spike_broadening&#39;: 0.7403041191114148,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:spike_frequency_adaptation&#39;: -0.01809717600857398,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:spike_width_adaptation&#39;: 0.009174879706803092,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:trough_decay_exponent&#39;: -0.02760451378209885,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;18:trough_phase_adaptation&#39;: -0.005774543184281237}</span>
<span class="go">Going over acquisition # 19</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;19:average_last_1percent&#39;: -60.855106353759766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:average_maximum&#39;: 53.430737,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:average_minimum&#39;: -37.713623,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:first_spike_time&#39;: 102.50000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:interspike_time_covar&#39;: 0.25333327224227414,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:max_interspike_time&#39;: 114.69999999999993,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:max_peak_no&#39;: 11,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:maximum&#39;: 60.607914,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:mean_spike_frequency&#39;: 12.47038284075321,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:min_interspike_time&#39;: 51.8,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:min_peak_no&#39;: 10,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:minimum&#39;: -61.248783,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:peak_decay_exponent&#39;: -0.04918301935790627,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:peak_linear_gradient&#39;: -0.008553290998046907,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:spike_broadening&#39;: 0.7301692622822238,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:spike_frequency_adaptation&#39;: -0.015561797159916213,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:spike_width_adaptation&#39;: 0.010054185105794627,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:trough_decay_exponent&#39;: -0.03413795061471875,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;19:trough_phase_adaptation&#39;: -0.011967671377256838}</span>
<span class="go">Going over acquisition # 20</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;20:average_last_1percent&#39;: -60.793460845947266,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:average_maximum&#39;: 53.11169,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:average_minimum&#39;: -37.045288,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:first_spike_time&#39;: 101.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:interspike_time_covar&#39;: 0.2865607615520669,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:max_interspike_time&#39;: 123.0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:max_peak_no&#39;: 11,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:maximum&#39;: 60.51636,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:mean_spike_frequency&#39;: 12.624668602449184,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:min_interspike_time&#39;: 49.099999999999994,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:min_peak_no&#39;: 10,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:minimum&#39;: -61.30982,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:peak_decay_exponent&#39;: -0.053836942989781186,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:peak_linear_gradient&#39;: -0.009554089132365705,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:spike_broadening&#39;: 0.7067401817806985,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:spike_frequency_adaptation&#39;: -0.02046601020346991,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:spike_width_adaptation&#39;: 0.01032699280307952,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:trough_decay_exponent&#39;: -0.03229413870032492,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;20:trough_phase_adaptation&#39;: -0.009902402143729637}</span>
<span class="go">Going over acquisition # 21</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;21:average_last_1percent&#39;: -59.912113189697266,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:average_maximum&#39;: 51.912754,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:average_minimum&#39;: -35.964966,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:first_spike_time&#39;: 100.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:interspike_time_covar&#39;: 0.31784939578511834,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:max_interspike_time&#39;: 130.10000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:max_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:maximum&#39;: 61.15723,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:mean_spike_frequency&#39;: 12.369858777445623,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:min_interspike_time&#39;: 45.10000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:min_peak_no&#39;: 12,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:minimum&#39;: -61.614994,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:peak_decay_exponent&#39;: -0.06340663337165775,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:peak_linear_gradient&#39;: -0.009514554022982258,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:spike_broadening&#39;: 0.6805457955255507,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:spike_frequency_adaptation&#39;: -0.012321447021551269,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:spike_width_adaptation&#39;: 0.007303096579113352,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:trough_decay_exponent&#39;: -0.03236374133246423,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;21:trough_phase_adaptation&#39;: -0.009705621425080494}</span>
<span class="go">Going over acquisition # 22</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;22:average_last_1percent&#39;: -60.0850461324056,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:average_maximum&#39;: 51.325874,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:average_minimum&#39;: -35.22746,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:first_spike_time&#39;: 97.7,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:interspike_time_covar&#39;: 0.3280130255436152,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:max_interspike_time&#39;: 123.30000000000007,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:max_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:maximum&#39;: 60.91309,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:mean_spike_frequency&#39;: 12.784998934583422,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:min_interspike_time&#39;: 40.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:min_peak_no&#39;: 12,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:minimum&#39;: -60.51636,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:peak_decay_exponent&#39;: -0.07398649685748288,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:peak_linear_gradient&#39;: -0.008846573199048182,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:spike_broadening&#39;: 0.673572178798493,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:spike_frequency_adaptation&#39;: -0.01394751742502263,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:spike_width_adaptation&#39;: 0.00745978471908774,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:trough_decay_exponent&#39;: -0.03985576781966312,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;22:trough_phase_adaptation&#39;: -0.012949190338366346}</span>
<span class="go">Going over acquisition # 23</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;23:average_last_1percent&#39;: -60.42582575480143,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:average_maximum&#39;: 50.883705,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:average_minimum&#39;: -34.70553,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:first_spike_time&#39;: 97.0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:interspike_time_covar&#39;: 0.3025008293643565,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:max_interspike_time&#39;: 113.00000000000011,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:maximum&#39;: 61.126713,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:mean_spike_frequency&#39;: 13.453378867846421,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:min_interspike_time&#39;: 37.599999999999994,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:minimum&#39;: -60.79102,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:peak_decay_exponent&#39;: -0.09454776279913378,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:peak_linear_gradient&#39;: -0.007913299554316041,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:spike_broadening&#39;: 0.6664213397577756,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:spike_frequency_adaptation&#39;: -0.014974747741974222,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:spike_width_adaptation&#39;: 0.0067844847504214744,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:trough_decay_exponent&#39;: -0.04357925225307838,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;23:trough_phase_adaptation&#39;: -0.006437508651280852}</span>
<span class="go">Going over acquisition # 24</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;24:average_last_1percent&#39;: -60.48380915323893,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:average_maximum&#39;: 50.66572,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:average_minimum&#39;: -34.043533,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:first_spike_time&#39;: 95.9,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:interspike_time_covar&#39;: 0.2757061784222999,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:max_interspike_time&#39;: 106.29999999999995,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:maximum&#39;: 61.2793,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:mean_spike_frequency&#39;: 13.685651121170649,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:min_interspike_time&#39;: 42.5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:minimum&#39;: -61.03516,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:peak_decay_exponent&#39;: -0.10291055243646331,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:peak_linear_gradient&#39;: -0.008156801002617309,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:spike_broadening&#39;: 0.647962840377368,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:spike_frequency_adaptation&#39;: -0.01033640102347251,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:spike_width_adaptation&#39;: 0.0070544336550024695,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:trough_decay_exponent&#39;: -0.04136814132208841,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;24:trough_phase_adaptation&#39;: -0.007165702258804302}</span>
<span class="go">Going over acquisition # 25</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;25:average_last_1percent&#39;: -60.056766510009766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:average_maximum&#39;: 50.34093,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:average_minimum&#39;: -33.228947,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:first_spike_time&#39;: 95.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:interspike_time_covar&#39;: 0.28833246313094774,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:max_interspike_time&#39;: 100.80000000000007,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:maximum&#39;: 61.40137,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:mean_spike_frequency&#39;: 14.023732470334416,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:min_interspike_time&#39;: 39.10000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:minimum&#39;: -60.607914,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:peak_decay_exponent&#39;: -0.1047695739806843,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:peak_linear_gradient&#39;: -0.00879119329941481,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:spike_broadening&#39;: 0.6394636967007732,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:spike_frequency_adaptation&#39;: -0.011357738090467376,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:spike_width_adaptation&#39;: 0.007198805900434394,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:trough_decay_exponent&#39;: -0.03898706127522965,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;25:trough_phase_adaptation&#39;: -0.005791081007349543}</span>
<span class="go">Going over acquisition # 26</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;26:average_last_1percent&#39;: -60.2272580464681,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:average_maximum&#39;: 49.776356,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:average_minimum&#39;: -32.534084,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:first_spike_time&#39;: 94.89999999999999,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:interspike_time_covar&#39;: 0.3174070553930572,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:max_interspike_time&#39;: 115.70000000000005,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:maximum&#39;: 61.15723,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:mean_spike_frequency&#39;: 14.697569248162802,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:min_interspike_time&#39;: 35.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:minimum&#39;: -60.729984,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:peak_decay_exponent&#39;: -0.11931629839276492,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:peak_linear_gradient&#39;: -0.009603020729143796,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:spike_broadening&#39;: 0.6253471365146865,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:spike_frequency_adaptation&#39;: -0.015585439927950483,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:spike_width_adaptation&#39;: 0.007759081127414656,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:trough_decay_exponent&#39;: -0.049101688628808246,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;26:trough_phase_adaptation&#39;: -0.012139424609633551}</span>
<span class="go">Going over acquisition # 27</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;27:average_last_1percent&#39;: -60.3578732808431,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:average_maximum&#39;: 49.30769,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:average_minimum&#39;: -32.003548,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:first_spike_time&#39;: 93.60000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:interspike_time_covar&#39;: 0.309017296765978,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:max_interspike_time&#39;: 109.0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:maximum&#39;: 61.43189,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:mean_spike_frequency&#39;: 14.729209154769997,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:min_interspike_time&#39;: 32.19999999999999,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:minimum&#39;: -60.7605,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:peak_decay_exponent&#39;: -0.12538878925370048,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:peak_linear_gradient&#39;: -0.009067695791685005,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:spike_broadening&#39;: 0.6066765033439258,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:spike_frequency_adaptation&#39;: -0.015492078035720953,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:spike_width_adaptation&#39;: 0.007539073044770246,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:trough_decay_exponent&#39;: -0.05115040330367209,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;27:trough_phase_adaptation&#39;: -0.012545852013557039}</span>
<span class="go">Going over acquisition # 28</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;28:average_last_1percent&#39;: -60.3798459370931,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:average_maximum&#39;: 48.999027,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:average_minimum&#39;: -31.055996,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:first_spike_time&#39;: 93.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:interspike_time_covar&#39;: 0.30636145843159784,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:max_interspike_time&#39;: 104.70000000000005,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:max_peak_no&#39;: 15,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:maximum&#39;: 61.2793,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:mean_spike_frequency&#39;: 14.760147601476012,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:min_interspike_time&#39;: 34.20000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:min_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:minimum&#39;: -60.943607,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:peak_decay_exponent&#39;: -0.16496940386452533,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:peak_linear_gradient&#39;: -0.007631694348641044,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:spike_broadening&#39;: 0.5953810644123492,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:spike_frequency_adaptation&#39;: -0.014342884276047468,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:spike_width_adaptation&#39;: 0.006650416835633624,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:trough_decay_exponent&#39;: -0.04668774074305247,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;28:trough_phase_adaptation&#39;: 0.006738292518776989}</span>
<span class="go">Going over acquisition # 29</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;29:average_last_1percent&#39;: -60.662235260009766,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:average_maximum&#39;: 48.664642,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:average_minimum&#39;: -30.39551,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:first_spike_time&#39;: 93.10000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:interspike_time_covar&#39;: 0.5343365146969321,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:max_interspike_time&#39;: 183.60000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:maximum&#39;: 61.370853,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:mean_spike_frequency&#39;: 14.458903347792235,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:min_interspike_time&#39;: 25.599999999999994,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:minimum&#39;: -61.187748,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:peak_decay_exponent&#39;: -0.15153571047754788,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:peak_linear_gradient&#39;: -0.007862338819211844,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:spike_broadening&#39;: 0.5870269764023183,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:spike_frequency_adaptation&#39;: -0.016055090374903703,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:spike_width_adaptation&#39;: 0.00754720476623759,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:trough_decay_exponent&#39;: -0.05167436400749407,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;29:trough_phase_adaptation&#39;: 0.006928896725677521}</span>
<span class="go">Going over acquisition # 30</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;30:average_last_1percent&#39;: -60.68766657511393,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:average_maximum&#39;: 48.13843,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:average_minimum&#39;: -29.626032,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:first_spike_time&#39;: 92.80000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:interspike_time_covar&#39;: 0.34247923269889735,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:max_interspike_time&#39;: 103.89999999999998,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:max_peak_no&#39;: 15,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:maximum&#39;: 61.767582,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:mean_spike_frequency&#39;: 15.688032272523532,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:min_interspike_time&#39;: 24.599999999999994,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:min_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:minimum&#39;: -61.248783,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:peak_decay_exponent&#39;: -0.19194537406993217,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:peak_linear_gradient&#39;: -0.006994401512067068,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:spike_broadening&#39;: 0.5770492253613585,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:spike_frequency_adaptation&#39;: -0.01538364588730742,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:spike_width_adaptation&#39;: 0.0069293286774622966,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:trough_decay_exponent&#39;: -0.04326627973106321,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;30:trough_phase_adaptation&#39;: 0.0064812799362231775}</span>
<span class="go">Going over acquisition # 31</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;31:average_last_1percent&#39;: -60.63212458292643,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:average_maximum&#39;: 48.024498,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:average_minimum&#39;: -29.024399,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:first_spike_time&#39;: 92.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:interspike_time_covar&#39;: 0.406847478416553,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:max_interspike_time&#39;: 133.5999999999999,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:max_peak_no&#39;: 15,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:maximum&#39;: 61.889652,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:mean_spike_frequency&#39;: 14.704337779644996,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:min_interspike_time&#39;: 29.5,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:min_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:minimum&#39;: -61.30982,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:peak_decay_exponent&#39;: -0.1671016453568311,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:peak_linear_gradient&#39;: -0.0086990196695813,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:spike_broadening&#39;: 0.5569432887124698,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:spike_frequency_adaptation&#39;: -0.014767300558908368,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:spike_width_adaptation&#39;: 0.006743383637276833,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:trough_decay_exponent&#39;: -0.04051025499900451,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;31:trough_phase_adaptation&#39;: 0.006526251236739548}</span>
<span class="go">Going over acquisition # 32</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;32:average_last_1percent&#39;: -59.76054255167643,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:average_maximum&#39;: 47.896324,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:average_minimum&#39;: -27.88653,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:first_spike_time&#39;: 91.30000000000001,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:interspike_time_covar&#39;: 0.34354448310799324,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:max_interspike_time&#39;: 106.60000000000002,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:max_peak_no&#39;: 15,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:maximum&#39;: 62.469486,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:mean_spike_frequency&#39;: 15.222355115798628,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:min_interspike_time&#39;: 30.700000000000003,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:min_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:minimum&#39;: -60.42481,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:peak_decay_exponent&#39;: -0.2052962133940038,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:peak_linear_gradient&#39;: -0.00818069814788547,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:spike_broadening&#39;: 0.5505132639070699,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:spike_frequency_adaptation&#39;: -0.0127147931736426,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:spike_width_adaptation&#39;: 0.006794945084249822,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:trough_decay_exponent&#39;: -0.045165955567810896,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;32:trough_phase_adaptation&#39;: 0.00648520248429949}</span>
<span class="go">Going over acquisition # 33</span>
<span class="go">pyelectro &gt;&gt;&gt; {   &#39;33:average_last_1percent&#39;: -59.76237360636393,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:average_maximum&#39;: 47.544212,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:average_minimum&#39;: -27.22403,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:first_spike_time&#39;: 91.4,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:interspike_time_covar&#39;: 0.9530683477414146,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:max_interspike_time&#39;: 322.6,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:max_peak_no&#39;: 14,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:maximum&#39;: 62.28638,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:mean_spike_frequency&#39;: 13.151239251390995,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:min_interspike_time&#39;: 29.0,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:min_peak_no&#39;: 13,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:minimum&#39;: -60.42481,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:peak_decay_exponent&#39;: -0.21944646857580366,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:peak_linear_gradient&#39;: -0.00986060329457358,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:spike_broadening&#39;: 0.5524597059029492,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:spike_frequency_adaptation&#39;: -0.01666625273183203,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:spike_width_adaptation&#39;: 0.006743589954469429,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:trough_decay_exponent&#39;: -0.03685620725832345,</span>
<span class="go">pyelectro &gt;&gt;&gt;     &#39;33:trough_phase_adaptation&#39;: -0.012225503917922204}</span>
</pre></div>
</div>
<p>We now have the following information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">analysis_results</span></code>: the results of the analysis by PyElectro; we need these to set the target values for our fitting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">currents</span></code>: the value of stimulation current for each sweep we’ve chosen; we need this for our models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memb_vals</span></code>: the time series of the membrane potentials and recordings times; we’ll use this to plot the membrane potentials later to compare our fitted model against</p></li>
</ul>
</section>
<section id="running-the-optimisation">
<span id="userdocs-optimising-running"></span><h2>Running the optimisation<a class="headerlink" href="#running-the-optimisation" title="Link to this heading">#</a></h2>
<p>To run the optimisation, we want to choose which of the 33 time series we want to fit our model against.
Ideally, we would want to fit our model to all of them.
Here, however, for simplicity and to keep the computation time in check, we only pick two of the 33 sweeps.
(As an exercise, you can change the list to see how that affects your fitting.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">sweeps_to_tune_against</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">tune_izh_model</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">,</span> <span class="n">analysis_results</span><span class="p">,</span> <span class="n">currents</span><span class="p">)</span>
</pre></div>
</div>
<p>The Neurotune optimiser uses the evolutionary computation method provided by the <a class="reference external" href="https://github.com/aarongarrett/inspyred/">Inspyred</a> package.
In short:</p>
<ul class="simple">
<li><p>the evolutionary algorithm starts with a population of models, each with a random value for a set of parameters constrained by a max/min value we have supplied</p></li>
<li><p>it then calculates a fitness value for each model by comparing the features generated by the model to the target features that we provide</p></li>
<li><p>in each generation, it finds the fittest models (parents)</p></li>
<li><p>it mutates these to generate the next generation of models (offspring)</p></li>
<li><p>it replaces the least fit models with fittest of the new individuals</p></li>
</ul>
<p>The idea is that by calculating the fittest parents and offspring, it will find the candidate models that fit the provided target data best.
You can read more about evolutionary computation online (e.g. <a class="reference external" href="https://en.wikipedia.org/wiki/Evolutionary_algorithm">Wikipedia</a>).
More information on model fitting in computational neuroscience can also be found in the literature.
For example, see this review <span id="id2">[<a class="reference internal" href="../Reference/zBibliography.html#id19" title="Astrid A. Prinz, Dirk Bucher, and Eve Marder. Similar network activity from disparate circuit parameters. Nature Neuroscience, 7(12):1345–1352, 2004. doi:10.1038/nn1352.">PBM04</a>, <a class="reference internal" href="../Reference/zBibliography.html#id18" title="Cyrille Rossant, Dan F. Goodman, Bertrand Fontaine, Jonathan Platkiewicz, Anna Magnusson, and Romain Brette. Fitting neuron models to spike trains. Frontiers in Neuroscience, 5:9, 2011. URL: https://www.frontiersin.org/article/10.3389/fnins.2011.00009, doi:10.3389/fnins.2011.00009.">RGF+11</a>]</span>.</p>
<p>Here, we follow the following steps:</p>
<ul class="simple">
<li><p>we set up a template NeuroML model that will be passed to the optimiser</p></li>
<li><p>we list the parameters we want to fit, and provide the extents of their state spaces</p></li>
<li><p>we list the target features that the optimiser will use to calculate fitness, and set their weights</p></li>
<li><p>finally, we use the <code class="docutils literal notranslate"><span class="pre">run_optimisation</span></code> function to run the optimisation</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">tune_izh_model</span></code> function shown below is the main workhorse function that does our fitting:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tune_izh_model</span><span class="p">(</span><span class="n">acq_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">metrics_from_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">currents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tune networks model against the data.</span>

<span class="sd">    Here we generate a network with the necessary number of Izhikevich cells,</span>
<span class="sd">    one for each current stimulus, and tune them against the experimental data.</span>

<span class="sd">    :param acq_list: list of indices of acquisitions/sweeps to tune against</span>
<span class="sd">    :type acq_list: list</span>
<span class="sd">    :param metrics_from_data: dictionary with the sweep number as index, and</span>
<span class="sd">        the dictionary containing metrics generated from the analysis</span>
<span class="sd">    :type metrics_from_data: dict</span>
<span class="sd">    :param currents: dictionary with sweep number as index and stimulus current</span>
<span class="sd">        value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># length of simulation of the cells---should match the length of the</span>
    <span class="c1"># experiment</span>
    <span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1500.0</span>
    <span class="c1"># Create a NeuroML template network simulation file that we will use for</span>
    <span class="c1"># the tuning</span>
    <span class="n">template_doc</span> <span class="o">=</span> <span class="n">NeuroMLDocument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;IzhTuneNet&quot;</span><span class="p">)</span>
    <span class="c1"># Add an Izhikevich cell with some parameters to the document</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">izhikevich2007_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Izhikevich2007Cell</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="s2">&quot;100pF&quot;</span><span class="p">,</span>
            <span class="n">v0</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="s2">&quot;0.7nS_per_mV&quot;</span><span class="p">,</span>
            <span class="n">vr</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">vt</span><span class="o">=</span><span class="s2">&quot;-40mV&quot;</span><span class="p">,</span>
            <span class="n">vpeak</span><span class="o">=</span><span class="s2">&quot;35mV&quot;</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="s2">&quot;0.03per_ms&quot;</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="s2">&quot;-2nS&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;-50.0mV&quot;</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="s2">&quot;100pA&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">))</span>
    <span class="c1"># Add a cell for each acquisition list</span>
    <span class="n">popsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pop0&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">popsize</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a current source for each cell, matching the currents that</span>
    <span class="c1"># were used in the experimental study.</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">pulse_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PulseGenerator</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span>
                <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;80ms&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;1000ms&quot;</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explicit_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ExplicitInput</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Print a summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">template_doc</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Write to a neuroml file and validate it.</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;TuneIzhFergusonPyr3&quot;</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.net.nml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">write_neuroml2_file</span><span class="p">(</span><span class="n">template_doc</span><span class="p">,</span> <span class="n">template_filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Now for the tuning bits</span>

    <span class="c1"># format is type:id/variable:id/units</span>
    <span class="c1"># supported types: cell/channel/izhikevich2007cell</span>
    <span class="c1"># supported variables:</span>
    <span class="c1">#  - channel: vShift</span>
    <span class="c1">#  - cell: channelDensity, vShift_channelDensity, channelDensityNernst,</span>
    <span class="c1">#  erev_id, erev_ion, specificCapacitance, resistivity</span>
    <span class="c1">#  - izhikevich2007Cell: all available attributes</span>

    <span class="c1"># we want to tune these parameters within these ranges</span>
    <span class="c1"># param: (min, max)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/C/pF&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/k/nS_per_mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vr/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vt/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vpeak/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/a/per_ms&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/b/nS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/c/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/d/pA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[str, Tuple[float, float]]</span>

    <span class="c1"># Set up our target data and so on</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="c1"># data to fit to:</span>
        <span class="c1"># format: path/to/variable:metric</span>
        <span class="c1"># metric from pyelectro, for example:</span>
        <span class="c1"># https://pyelectro.readthedocs.io/en/latest/pyelectro.html?highlight=mean_spike_frequency#pyelectro.analysis.mean_spike_frequency</span>
        <span class="n">mean_spike_frequency</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">average_last_1percent</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">first_spike_time</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>

        <span class="c1"># each metric can have an associated weight</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># value of the target data from our data set</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># only add these if the experimental data includes them</span>
        <span class="c1"># these are only generated for traces with spikes</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_maximum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_minimum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># simulator to use</span>
    <span class="n">simulator</span> <span class="o">=</span> <span class="s2">&quot;jNeuroML&quot;</span>

    <span class="k">return</span> <span class="n">run_optimisation</span><span class="p">(</span>
        <span class="c1"># Prefix for new files</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;TuneIzh&quot;</span><span class="p">,</span>
        <span class="c1"># Name of the NeuroML template file</span>
        <span class="n">neuroml_file</span><span class="o">=</span><span class="n">template_filename</span><span class="p">,</span>
        <span class="c1"># Name of the network</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">,</span>
        <span class="c1"># Parameters to be fitted</span>
        <span class="n">parameters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="c1"># Our max and min constraints</span>
        <span class="n">min_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="n">max_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="c1"># Weights we set for parameters</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="c1"># The experimental metrics to fit to</span>
        <span class="n">target_data</span><span class="o">=</span><span class="n">target_data</span><span class="p">,</span>
        <span class="c1"># Simulation time</span>
        <span class="n">sim_time</span><span class="o">=</span><span class="n">sim_time</span><span class="p">,</span>
        <span class="c1"># EC parameters</span>
        <span class="n">population_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">max_evaluations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">num_selected</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">num_offspring</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">num_elites</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="c1"># Seed value</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span>
        <span class="c1"># Simulator</span>
        <span class="n">simulator</span><span class="o">=</span><span class="n">simulator</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="s1">&#39;-nogui&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span>
        <span class="n">save_to_file</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_fitness.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_scatter</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_scatter.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_hist</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_hist.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_output</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_output.png&quot;</span><span class="p">,</span>
        <span class="n">num_parallel_evaluations</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Let us walk through the different sections of this function.</p>
<section id="writing-a-template-model">
<span id="userdocs-optimising-running-template"></span><h3>Writing a template model<a class="headerlink" href="#writing-a-template-model" title="Link to this heading">#</a></h3>
<p>In this example, we want to fit the parameters of an <a class="reference internal" href="Schemas/Cells.html#schema-izhikevich2007cell"><span class="std std-ref">Izhikevich cell</span></a> to our data such that simulating the cell then gives us membrane potentials similar to those observed in the experiment.
Following the <a class="reference internal" href="SingleNeuronExample.html#userdocs-getting-started-single-example"><span class="std std-ref">Izhikevich network example</span></a>, we set up a template network with one Izhikevich cell for each experimental recording that we want to fit.
For each of these cells, we provide a current stimulus matching the current used in the current clamp experiments that we obtained our recordings from:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># length of simulation of the cells---should match the length of the</span>
    <span class="c1"># experiment</span>
    <span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1500.0</span>
    <span class="c1"># Create a NeuroML template network simulation file that we will use for</span>
    <span class="c1"># the tuning</span>
    <span class="n">template_doc</span> <span class="o">=</span> <span class="n">NeuroMLDocument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;IzhTuneNet&quot;</span><span class="p">)</span>
    <span class="c1"># Add an Izhikevich cell with some parameters to the document</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">izhikevich2007_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Izhikevich2007Cell</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="s2">&quot;100pF&quot;</span><span class="p">,</span>
            <span class="n">v0</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="s2">&quot;0.7nS_per_mV&quot;</span><span class="p">,</span>
            <span class="n">vr</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">vt</span><span class="o">=</span><span class="s2">&quot;-40mV&quot;</span><span class="p">,</span>
            <span class="n">vpeak</span><span class="o">=</span><span class="s2">&quot;35mV&quot;</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="s2">&quot;0.03per_ms&quot;</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="s2">&quot;-2nS&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;-50.0mV&quot;</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="s2">&quot;100pA&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">))</span>
    <span class="c1"># Add a cell for each acquisition list</span>
    <span class="n">popsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
    <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pop0&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">popsize</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a current source for each cell, matching the currents that</span>
    <span class="c1"># were used in the experimental study.</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">pulse_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PulseGenerator</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span>
                <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;80ms&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;1000ms&quot;</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">template_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explicit_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ExplicitInput</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Print a summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">template_doc</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Write to a neuroml file and validate it.</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;TuneIzhFergusonPyr3&quot;</span>
    <span class="n">template_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.net.nml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">write_neuroml2_file</span><span class="p">(</span><span class="n">template_doc</span><span class="p">,</span> <span class="n">template_filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The resultant network template model for our two chosen recordings is shown below:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;neuroml</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.neuroml.org/schema/neuroml2&quot;</span><span class="w">  </span><span class="na">xmlns:xs=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class="w"> </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="w"> </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.neuroml.org/schema/neuroml2 https://raw.github.com/NeuroML/NeuroML2/development/Schemas/NeuroML2/NeuroML_v2.2.xsd&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;IzhTuneNet&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;izhikevich2007Cell</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;Izh2007&quot;</span><span class="w"> </span><span class="na">C=</span><span class="s">&quot;100pF&quot;</span><span class="w"> </span><span class="na">v0=</span><span class="s">&quot;-60mV&quot;</span><span class="w"> </span><span class="na">k=</span><span class="s">&quot;0.7nS_per_mV&quot;</span><span class="w"> </span><span class="na">vr=</span><span class="s">&quot;-60mV&quot;</span><span class="w"> </span><span class="na">vt=</span><span class="s">&quot;-40mV&quot;</span><span class="w"> </span><span class="na">vpeak=</span><span class="s">&quot;35mV&quot;</span><span class="w"> </span><span class="na">a=</span><span class="s">&quot;0.03per_ms&quot;</span><span class="w"> </span><span class="na">b=</span><span class="s">&quot;-2nS&quot;</span><span class="w"> </span><span class="na">c=</span><span class="s">&quot;-50.0mV&quot;</span><span class="w"> </span><span class="na">d=</span><span class="s">&quot;100pA&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;pulseGenerator</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;Stim0&quot;</span><span class="w"> </span><span class="na">delay=</span><span class="s">&quot;80ms&quot;</span><span class="w"> </span><span class="na">duration=</span><span class="s">&quot;1000ms&quot;</span><span class="w"> </span><span class="na">amplitude=</span><span class="s">&quot;152.0pA&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;pulseGenerator</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;Stim1&quot;</span><span class="w"> </span><span class="na">delay=</span><span class="s">&quot;80ms&quot;</span><span class="w"> </span><span class="na">duration=</span><span class="s">&quot;1000ms&quot;</span><span class="w"> </span><span class="na">amplitude=</span><span class="s">&quot;202.0pA&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;network</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;Network0&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;population</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;Pop0&quot;</span><span class="w"> </span><span class="na">component=</span><span class="s">&quot;Izh2007&quot;</span><span class="w"> </span><span class="na">size=</span><span class="s">&quot;2&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;explicitInput</span><span class="w"> </span><span class="na">target=</span><span class="s">&quot;Pop0[0]&quot;</span><span class="w"> </span><span class="na">input=</span><span class="s">&quot;Stim0&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;explicitInput</span><span class="w"> </span><span class="na">target=</span><span class="s">&quot;Pop0[1]&quot;</span><span class="w"> </span><span class="na">input=</span><span class="s">&quot;Stim1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/network&gt;</span>
<span class="nt">&lt;/neuroml&gt;</span>
</pre></div>
</div>
<p>Please note that the initial parameters of the Izhikevich Cell do not matter here because the optimiser will modify these to run the candidate simulations.</p>
</section>
<section id="setting-up-the-optimisation-parameters">
<span id="userdocs-optimising-running-params"></span><h3>Setting up the optimisation parameters<a class="headerlink" href="#setting-up-the-optimisation-parameters" title="Link to this heading">#</a></h3>
<p>The next step is to set the features/metrics that we want to fit:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">parameters</span></code> dictionary contains the specifications of the parameters that we wish to fit, along with their minimum and maximum permitted values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># we want to tune these parameters within these ranges</span>
    <span class="c1"># param: (min, max)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/C/pF&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/k/nS_per_mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vr/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vt/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/vpeak/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/a/per_ms&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/b/nS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/c/mV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">65</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;izhikevich2007Cell:Izh2007/d/pA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="p">}</span>  <span class="c1"># type: Dict[str, Tuple[float, float]]</span>
</pre></div>
</div>
<p>The format of the parameter specification is: <code class="docutils literal notranslate"><span class="pre">ComponentType:ComponentID/VariableName[:VariableID]/Units</span></code>.
So, for example, to fit the Capacitance of the Izhikevich cell, our parameter specification string is: <code class="docutils literal notranslate"><span class="pre">izhikevich2007Cell:Izh2007/C/pF</span></code>.</p>
<p>All NeuroML <a class="reference internal" href="Schemas/Cells.html#schema-cells"><span class="std std-ref">Cell</span></a> and <a class="reference internal" href="Schemas/Channels.html#schema-channels"><span class="std std-ref">Channel</span></a> ComponentTypes can be fitted using the <code class="docutils literal notranslate"><span class="pre">NeuroMLTuner</span></code>.</p>
<p>Next, we specify the target data that we want to fit against.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Set up our target data and so on</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
        <span class="c1"># data to fit to:</span>
        <span class="c1"># format: path/to/variable:metric</span>
        <span class="c1"># metric from pyelectro, for example:</span>
        <span class="c1"># https://pyelectro.readthedocs.io/en/latest/pyelectro.html?highlight=mean_spike_frequency#pyelectro.analysis.mean_spike_frequency</span>
        <span class="n">mean_spike_frequency</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">average_last_1percent</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
        <span class="n">first_spike_time</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>

        <span class="c1"># each metric can have an associated weight</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># value of the target data from our data set</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">mean_spike_frequency</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:mean_spike_frequency&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">average_last_1percent</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_last_1percent&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">target_data</span><span class="p">[</span><span class="n">first_spike_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:first_spike_time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># only add these if the experimental data includes them</span>
        <span class="c1"># these are only generated for traces with spikes</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_maximum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_maximum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_maximum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">]:</span>
            <span class="n">average_minimum</span> <span class="o">=</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">target_data</span><span class="p">[</span><span class="n">average_minimum</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_from_data</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:average_minimum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="n">ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>As we have set up a cell for each recording that we want to fit to, we must also set the target value for each cell.
We pick four features from a subset of features that PyElectro provided us with:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mean_spike_frequency</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">average_last_1percent</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">average_maximum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">average_minimum</span></code></p></li>
</ul>
<p>The last two can only be calculated for membrane potential data that includes spikes.
Since a few of the experimental recordings to not show any spikes, these two metrics will not be calculated for them.
So, we only add them for the corresponding cell only if they are present in the features for the chosen recording.</p>
<p>The format for the <code class="docutils literal notranslate"><span class="pre">target_data</span></code> is similar to that of the <code class="docutils literal notranslate"><span class="pre">parameters</span></code>.
The keys of the <code class="docutils literal notranslate"><span class="pre">target_data</span></code> dictionary are the specifications for the metrics.
The format for these is: <code class="docutils literal notranslate"><span class="pre">path/to/variable:pyelectro</span> <span class="pre">metric</span></code>.
You can learn more about constructing paths in NeuroML <a class="reference internal" href="Paths.html#userdocs-paths"><span class="std std-ref">here</span></a>.
The value for the each key is the corresponding metric that was calculated for us by PyElectro (in <code class="docutils literal notranslate"><span class="pre">analysis_results</span></code>).
The for loop will set the <code class="docutils literal notranslate"><span class="pre">target_data</span></code> to this (printed by pyNeuroML when we run the script):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">target_data</span> <span class="o">=</span>  <span class="p">{</span>
  <span class="s1">&#39;Pop0[0]/v:mean_spike_frequency&#39;</span><span class="p">:</span> <span class="mf">7.033585370142431</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[0]/v:average_last_1percent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">60.84635798136393</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[0]/v:average_maximum&#39;</span><span class="p">:</span> <span class="mf">58.73414</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[0]/v:average_minimum&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">43.800358</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[1]/v:mean_spike_frequency&#39;</span><span class="p">:</span> <span class="mf">10.8837614279495</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[1]/v:average_last_1percent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">60.380863189697266</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[1]/v:average_maximum&#39;</span><span class="p">:</span> <span class="mf">54.52382</span><span class="p">,</span>
  <span class="s1">&#39;Pop0[1]/v:average_minimum&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">39.78882</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Similarly, we also set up the weights for each target metric in the <code class="docutils literal notranslate"><span class="pre">weights</span></code> variable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;Pop0[0]/v:mean_spike_frequency&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[0]/v:average_last_1percent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[0]/v: average_maximum&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[0]/v:average_minimum&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[1]/v:mean_spike_frequency&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[1]/v:average_last_1percent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[1]/v:average_maximum&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;Pop0[1]/v:average_minimum&#39;</span><span class="p">:</span> <span class="mi">1</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>For simplicity, we set the weights for all as <code class="docutils literal notranslate"><span class="pre">1</span></code> here.</p>
</section>
<section id="calling-the-optimisation-function">
<span id="userdocs-optimising-running-call"></span><h3>Calling the optimisation function<a class="headerlink" href="#calling-the-optimisation-function" title="Link to this heading">#</a></h3>
<p>The last step is to call our <code class="docutils literal notranslate"><span class="pre">run_optimisation</span></code> function with the various parameters that we have set up.
Here, for simplicity, we use the <code class="docutils literal notranslate"><span class="pre">jNeuroML</span></code> simulator.
For multi-compartmental models, however, we will need to use the <code class="docutils literal notranslate"><span class="pre">jNeuroML_NEURON</span></code> simulator (since <code class="docutils literal notranslate"><span class="pre">jNeuroML</span></code> only supports single compartment simulations).
A number of arguments to the function are specific to evolutionary computation, and their discussion is beyond the scope of this tutorial.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># simulator to use</span>
    <span class="n">simulator</span> <span class="o">=</span> <span class="s2">&quot;jNeuroML&quot;</span>

    <span class="k">return</span> <span class="n">run_optimisation</span><span class="p">(</span>
        <span class="c1"># Prefix for new files</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;TuneIzh&quot;</span><span class="p">,</span>
        <span class="c1"># Name of the NeuroML template file</span>
        <span class="n">neuroml_file</span><span class="o">=</span><span class="n">template_filename</span><span class="p">,</span>
        <span class="c1"># Name of the network</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">,</span>
        <span class="c1"># Parameters to be fitted</span>
        <span class="n">parameters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="c1"># Our max and min constraints</span>
        <span class="n">min_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="n">max_constraints</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="c1"># Weights we set for parameters</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="c1"># The experimental metrics to fit to</span>
        <span class="n">target_data</span><span class="o">=</span><span class="n">target_data</span><span class="p">,</span>
        <span class="c1"># Simulation time</span>
        <span class="n">sim_time</span><span class="o">=</span><span class="n">sim_time</span><span class="p">,</span>
        <span class="c1"># EC parameters</span>
        <span class="n">population_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">max_evaluations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">num_selected</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">num_offspring</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">num_elites</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="c1"># Seed value</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span>
        <span class="c1"># Simulator</span>
        <span class="n">simulator</span><span class="o">=</span><span class="n">simulator</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="s1">&#39;-nogui&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span>
        <span class="n">save_to_file</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_fitness.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_scatter</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_scatter.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_hist</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_hist.png&quot;</span><span class="p">,</span>
        <span class="n">save_to_file_output</span><span class="o">=</span><span class="s2">&quot;fitted_izhikevich_output.png&quot;</span><span class="p">,</span>
        <span class="n">num_parallel_evaluations</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run_optimisation</span></code> function will print out the optimisation report, and also return it so that it can be stored in a variable for further use.
The terminal output is shown below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Ran 500 evaluations (pop: 100) in 582.205449 seconds (9.703424 mins total; 1.164411s per eval)</span>

<span class="go">---------- Best candidate ------------------------------------------</span>
<span class="go">{   &#39;Pop0[0]/v:average_last_1percent&#39;: -59.276969863333285,</span>
<span class="go">    &#39;Pop0[0]/v:average_maximum&#39;: 47.35760225,</span>
<span class="go">    &#39;Pop0[0]/v:average_minimum&#39;: -53.95061271428572,</span>
<span class="go">    &#39;Pop0[0]/v:first_spike_time&#39;: 170.1,</span>
<span class="go">    &#39;Pop0[0]/v:interspike_time_covar&#39;: 0.1330373936860586,</span>
<span class="go">    &#39;Pop0[0]/v:max_interspike_time&#39;: 190.57499999999982,</span>
<span class="go">    &#39;Pop0[0]/v:max_peak_no&#39;: 8,</span>
<span class="go">    &#39;Pop0[0]/v:maximum&#39;: 47.427714,</span>
<span class="go">    &#39;Pop0[0]/v:mean_spike_frequency&#39;: 6.957040276293886,</span>
<span class="go">    &#39;Pop0[0]/v:min_interspike_time&#39;: 135.25000000000003,</span>
<span class="go">    &#39;Pop0[0]/v:min_peak_no&#39;: 7,</span>
<span class="go">    &#39;Pop0[0]/v:minimum&#39;: -68.13577,</span>
<span class="go">    &#39;Pop0[0]/v:peak_decay_exponent&#39;: 0.0003379360943630205,</span>
<span class="go">    &#39;Pop0[0]/v:peak_linear_gradient&#39;: -3.270149536895308e-05,</span>
<span class="go">    &#39;Pop0[0]/v:spike_broadening&#39;: 0.982357731987536,</span>
<span class="go">    &#39;Pop0[0]/v:spike_frequency_adaptation&#39;: -0.016935379943933133,</span>
<span class="go">    &#39;Pop0[0]/v:spike_width_adaptation&#39;: 0.011971808793771004,</span>
<span class="go">    &#39;Pop0[0]/v:trough_decay_exponent&#39;: -0.0008421760726029059,</span>
<span class="go">    &#39;Pop0[0]/v:trough_phase_adaptation&#39;: -0.014231837120099502,</span>
<span class="go">    &#39;Pop0[1]/v:average_last_1percent&#39;: -59.28251401166662,</span>
<span class="go">    &#39;Pop0[1]/v:average_maximum&#39;: 47.242452454545464,</span>
<span class="go">    &#39;Pop0[1]/v:average_minimum&#39;: -48.287914,</span>
<span class="go">    &#39;Pop0[1]/v:first_spike_time&#39;: 146.7,</span>
<span class="go">    &#39;Pop0[1]/v:interspike_time_covar&#39;: 0.01075626702836981,</span>
<span class="go">    &#39;Pop0[1]/v:max_interspike_time&#39;: 91.67499999999998,</span>
<span class="go">    &#39;Pop0[1]/v:max_peak_no&#39;: 11,</span>
<span class="go">    &#39;Pop0[1]/v:maximum&#39;: 47.423363,</span>
<span class="go">    &#39;Pop0[1]/v:mean_spike_frequency&#39;: 10.973033769511423,</span>
<span class="go">    &#39;Pop0[1]/v:min_interspike_time&#39;: 88.20000000000002,</span>
<span class="go">    &#39;Pop0[1]/v:min_peak_no&#39;: 10,</span>
<span class="go">    &#39;Pop0[1]/v:minimum&#39;: -62.58064000000001,</span>
<span class="go">    &#39;Pop0[1]/v:peak_decay_exponent&#39;: 0.0008036004162568405,</span>
<span class="go">    &#39;Pop0[1]/v:peak_linear_gradient&#39;: -0.00012436953066659044,</span>
<span class="go">    &#39;Pop0[1]/v:spike_broadening&#39;: 0.9877761288704633,</span>
<span class="go">    &#39;Pop0[1]/v:spike_frequency_adaptation&#39;: 0.0064956079899488595,</span>
<span class="go">    &#39;Pop0[1]/v:spike_width_adaptation&#39;: 0.008982392557695507,</span>
<span class="go">    &#39;Pop0[1]/v:trough_decay_exponent&#39;: -0.004658690933014975,</span>
<span class="go">    &#39;Pop0[1]/v:trough_phase_adaptation&#39;: 0.009514671770845617}</span>

<span class="go">TARGETS:</span>
<span class="go">{   &#39;Pop0[0]/v:average_last_1percent&#39;: -60.84635798136393,</span>
<span class="go">    &#39;Pop0[0]/v:average_maximum&#39;: 58.73414,</span>
<span class="go">    &#39;Pop0[0]/v:average_minimum&#39;: -43.800358,</span>
<span class="go">    &#39;Pop0[0]/v:mean_spike_frequency&#39;: 7.033585370142431,</span>
<span class="go">    &#39;Pop0[1]/v:average_last_1percent&#39;: -60.380863189697266,</span>
<span class="go">    &#39;Pop0[1]/v:average_maximum&#39;: 54.52382,</span>
<span class="go">    &#39;Pop0[1]/v:average_minimum&#39;: -39.78882,</span>
<span class="go">    &#39;Pop0[1]/v:mean_spike_frequency&#39;: 10.8837614279495}</span>

<span class="go">TUNED VALUES:</span>
<span class="go">{   &#39;Pop0[0]/v:average_last_1percent&#39;: -59.276969863333285,</span>
<span class="go">    &#39;Pop0[0]/v:average_maximum&#39;: 47.35760225,</span>
<span class="go">    &#39;Pop0[0]/v:average_minimum&#39;: -53.95061271428572,</span>
<span class="go">    &#39;Pop0[0]/v:mean_spike_frequency&#39;: 6.957040276293886,</span>
<span class="go">    &#39;Pop0[1]/v:average_last_1percent&#39;: -59.28251401166662,</span>
<span class="go">    &#39;Pop0[1]/v:average_maximum&#39;: 47.242452454545464,</span>
<span class="go">    &#39;Pop0[1]/v:average_minimum&#39;: -48.287914,</span>
<span class="go">    &#39;Pop0[1]/v:mean_spike_frequency&#39;: 10.973033769511423}</span>

<span class="go">FITNESS: 0.003633</span>

<span class="go">FITTEST: {   &#39;izhikevich2007Cell:Izh2007/C/pF&#39;: 240.6982897890555,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/a/per_ms&#39;: 0.03863507615280202,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/b/nS&#39;: 2.0112449831346746,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/c/mV&#39;: -43.069939785498356,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/d/pA&#39;: 212.50982499591083,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/k/nS_per_mV&#39;: 0.24113869560362797,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/vpeak/mV&#39;: 47.44063356996336,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/vr/mV&#39;: -59.283747806929135,</span>
<span class="go">    &#39;izhikevich2007Cell:Izh2007/vt/mV&#39;: -48.9131459978619}</span>
</pre></div>
</div>
<p>It will also generate a number of plots (shown below):</p>
<ul class="simple">
<li><p>showing the evolution of the parameters being fitted, with indications of the fitness value: larger circles mean more fitness</p></li>
<li><p>the change in the overall fitness value as the population evolves</p></li>
<li><p>distributions of the values of the parameters being fitted, with indications of the fitness value: darker lines mean higher fitness</p></li>
</ul>
<figure class="align-default" id="id6">
<img alt="Evolution of parameters." src="../_images/fitted_izhikevich_scatter.png" />
<figcaption>
<p><span class="caption-number">Fig. 48 </span><span class="caption-text">The figure shows the values of various parameters throughout the evolution, with larger circles having higher values of fitness.</span><a class="headerlink" href="#id6" title="Link to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id7">
<img alt="Evolution of fitness." src="../_images/fitted_izhikevich_fitness.png" />
<figcaption>
<p><span class="caption-number">Fig. 49 </span><span class="caption-text">The figure shows the trend of the fitness throughout the evolution.</span><a class="headerlink" href="#id7" title="Link to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id8">
<img alt="Histograms of values of fitting parameters." src="../_images/fitted_izhikevich_hist.png" />
<figcaption>
<p><span class="caption-number">Fig. 50 </span><span class="caption-text">The figure shows the distribution of values that for each parameter throughout the evolution. Darker lines have higher fitness values.</span><a class="headerlink" href="#id8" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="viewing-results">
<span id="userdocs-optimising-results"></span><h2>Viewing results<a class="headerlink" href="#viewing-results" title="Link to this heading">#</a></h2>
<p>The tuner also generates a plot with the membrane potential of a cell using the fitted parameter values (shown on the top of the page).
Here, to document how the fitted parameters are to be extracted from the output of the <code class="docutils literal notranslate"><span class="pre">run_optimisation</span></code> function, we also construct a model to use the fitted parameters ourselves and plot the membrane potential to compare it against the experimental data.</p>
<section id="extracting-results-and-running-a-fitted-model">
<span id="userdocs-optimising-results-run-model"></span><h3>Extracting results and running a fitted model<a class="headerlink" href="#extracting-results-and-running-a-fitted-model" title="Link to this heading">#</a></h3>
<p>This is done in the <code class="docutils literal notranslate"><span class="pre">run_fitted_cell_simulation</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_fitted_cell_simulation</span><span class="p">(</span>
    <span class="n">sweeps_to_tune_against</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">tuning_report</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a simulation with the values obtained from the fitting</span>

<span class="sd">    :param tuning_report: tuning report from the optimser</span>
<span class="sd">    :type tuning_report: Dict</span>
<span class="sd">    :param simulation_id: text id of simulation</span>
<span class="sd">    :type simulation_id: str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the fittest variables</span>
    <span class="n">fittest_vars</span> <span class="o">=</span> <span class="n">tuning_report</span><span class="p">[</span><span class="s2">&quot;fittest vars&quot;</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/C/pF&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;pF&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/k/nS_per_mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;nS_per_mV&quot;</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vr/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">vt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vt/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">vpeak</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/vpeak/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/a/per_ms&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;per_ms&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/b/nS&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;nS&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/c/mV&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mV&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fittest_vars</span><span class="p">[</span><span class="s2">&quot;izhikevich2007Cell:Izh2007/d/pA&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;pA&quot;</span>

    <span class="c1"># Create a simulation using our obtained parameters.</span>
    <span class="c1"># Note that the tuner generates a graph with the fitted values already, but</span>
    <span class="c1"># we want to keep a copy of our fitted cell also, so we&#39;ll create a NeuroML</span>
    <span class="c1"># Document ourselves also.</span>
    <span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1500.0</span>
    <span class="n">simulation_doc</span> <span class="o">=</span> <span class="n">NeuroMLDocument</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;FittedNet&quot;</span><span class="p">)</span>
    <span class="c1"># Add an Izhikevich cell with some parameters to the document</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">izhikevich2007_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Izhikevich2007Cell</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
            <span class="n">v0</span><span class="o">=</span><span class="s2">&quot;-60mV&quot;</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">vr</span><span class="o">=</span><span class="n">vr</span><span class="p">,</span>
            <span class="n">vt</span><span class="o">=</span><span class="n">vt</span><span class="p">,</span>
            <span class="n">vpeak</span><span class="o">=</span><span class="n">vpeak</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">))</span>
    <span class="c1"># Add a cell for each acquisition list</span>
    <span class="n">popsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sweeps_to_tune_against</span><span class="p">)</span>
    <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Population</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pop0&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Izh2007&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">popsize</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Add a current source for each cell, matching the currents that</span>
    <span class="c1"># were used in the experimental study.</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">simulation_doc</span><span class="o">.</span><span class="n">pulse_generators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PulseGenerator</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span>
                <span class="n">delay</span><span class="o">=</span><span class="s2">&quot;80ms&quot;</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="s2">&quot;1000ms&quot;</span><span class="p">,</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">simulation_doc</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explicit_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ExplicitInput</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="nb">input</span><span class="o">=</span><span class="s2">&quot;Stim</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Print a summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simulation_doc</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Write to a neuroml file and validate it.</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;FittedIzhFergusonPyr3&quot;</span>
    <span class="n">simulation_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.net.nml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">write_neuroml2_file</span><span class="p">(</span><span class="n">simulation_doc</span><span class="p">,</span> <span class="n">simulation_filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">simulation</span> <span class="o">=</span> <span class="n">LEMSSimulation</span><span class="p">(</span>
        <span class="n">sim_id</span><span class="o">=</span><span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">sim_time</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Network0&quot;</span><span class="p">,</span>
        <span class="n">simulation_seed</span><span class="o">=</span><span class="mi">54321</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">include_neuroml2_file</span><span class="p">(</span><span class="n">simulation_filename</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">create_output_file</span><span class="p">(</span><span class="s2">&quot;output0&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.v.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simulation_id</span><span class="p">))</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">add_column_to_output_file</span><span class="p">(</span>
            <span class="s2">&quot;output0&quot;</span><span class="p">,</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="s2">&quot;Pop0[</span><span class="si">{}</span><span class="s2">]/v&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">simulation_file</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">()</span>
    <span class="c1"># simulate</span>
    <span class="n">run_lems_with_jneuroml</span><span class="p">(</span><span class="n">simulation_file</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="s2">&quot;2G&quot;</span><span class="p">,</span> <span class="n">nogui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
<p>First, we extract the fitted parameters from the dictionary returned by the <code class="docutils literal notranslate"><span class="pre">run_optimisation</span></code> function.
Then, we use these parameters to set up a simple NeuroML network and run a test simulation, recording the values of membrane potentials generated by the cells.
Please note that the current stimulus to the cells in this test model must also match the values that were used in the experiment, and so also in the fitting.</p>
</section>
<section id="plotting-model-generated-and-experimentally-recorded-membrane-potentials">
<span id="userdocs-optimising-results-plotting"></span><h3>Plotting model generated and experimentally recorded membrane potentials<a class="headerlink" href="#plotting-model-generated-and-experimentally-recorded-membrane-potentials" title="Link to this heading">#</a></h3>
<p>Finally, in the <code class="docutils literal notranslate"><span class="pre">plot_sim_data</span></code> function, we plot the membrane potentials from our fitted cells and the experimental data to see visually inspect the results of our fitting:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_sim_data</span><span class="p">(</span>
    <span class="n">sweeps_to_tune_against</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">simulation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memb_pots</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot data from our fitted simulation</span>

<span class="sd">    :param simulation_id: string id of simulation</span>
<span class="sd">    :type simulation_id: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plot</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.v.dat&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">)</span>

    <span class="c1"># construct data for plotting</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_vals_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sim_v_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_v_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_t_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stim_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">sweeps_to_tune_against</span><span class="p">:</span>
        <span class="n">stim_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">pA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currents</span><span class="p">[</span><span class="n">acq</span><span class="p">]))</span>

        <span class="c1"># remains the same for all columns</span>
        <span class="n">time_vals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">sim_v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_array</span><span class="p">[:,</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="n">data_v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memb_pots</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data_t_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memb_pots</span><span class="p">[</span><span class="n">acq</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Model membrane potential plot</span>
    <span class="n">generate_plot</span><span class="p">(</span>
        <span class="n">xvalues</span><span class="o">=</span><span class="n">time_vals_list</span><span class="p">,</span>
        <span class="n">yvalues</span><span class="o">=</span><span class="n">sim_v_list</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">stim_vals</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Membrane potential (model)&quot;</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_figure_to</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-model-v.png&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;time (ms)&quot;</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;membrane potential (mV)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># data membrane potential plot</span>
    <span class="n">generate_plot</span><span class="p">(</span>
        <span class="n">xvalues</span><span class="o">=</span><span class="n">data_t_list</span><span class="p">,</span>
        <span class="n">yvalues</span><span class="o">=</span><span class="n">data_v_list</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">stim_vals</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Membrane potential (exp)&quot;</span><span class="p">,</span>
        <span class="n">show_plot_already</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_figure_to</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-exp-v.png&quot;</span> <span class="o">%</span> <span class="n">simulation_id</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;time (ms)&quot;</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;membrane potential (mV)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


</pre></div>
</div>
<p>This generates the following figures:</p>
<div class="container-fluid">
<div class="row my-2 py-2">
<div class="col-sm-6 px-2">
<center>
<figure class="align-default" id="id9">
<img alt="Membrane potential from example experimental data." src="../_images/fitted_izhikevich_sim-exp-v.png" />
<figcaption>
<p><span class="caption-number">Fig. 51 </span><span class="caption-text">Membrane potential from the experimental data.</span><a class="headerlink" href="#id9" title="Link to this image">#</a></p>
</figcaption>
</figure>
</center>
</div>
<div class="col-sm-6 px-2">
<center>
<figure class="align-default" id="id10">
<img alt="Membrane potential obtained from example fitted model." src="../_images/fitted_izhikevich_output.png" />
<figcaption>
<p><span class="caption-number">Fig. 52 </span><span class="caption-text">Membrane potential obtained from the model with highest fitness.</span><a class="headerlink" href="#id10" title="Link to this image">#</a></p>
</figcaption>
</figure>
</center>
</div>
</div>
</div>
<p>We can clearly see the similarity between our fitted model and the experimental data.
A number of tweaks can be made to improve the fitting.
For example, pyNeuroML also provides a two staged optimisation function: <a class="reference external" href="https://pyneuroml.readthedocs.io/en/development/pyneuroml.tune.html#pyneuroml.tune.NeuroMLTuner.run_2stage_optimization">run_2stage_optimisation</a> that allows users to optimise sets of parameters in two different stages.
The graphs also show ranges of parameters that provide fits, so users can also hand-tune their models further as required.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "NeuroML/Documentation",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Userdocs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="SimulatingNeuroMLModels.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Simulating NeuroML Models</p>
      </div>
    </a>
    <a class="right-next"
       href="TestingNeuroMLModels.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Testing/validating NeuroML Models</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data-and-calculating-metrics-to-use-for-optimisation">Loading data and calculating metrics to use for optimisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-optimisation">Running the optimisation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-a-template-model">Writing a template model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-optimisation-parameters">Setting up the optimisation parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calling-the-optimisation-function">Calling the optimisation function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-results">Viewing results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-results-and-running-a-fitted-model">Extracting results and running a fitted model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-model-generated-and-experimentally-recorded-membrane-potentials">Plotting model generated and experimentally recorded membrane potentials</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By NeuroML contributors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>